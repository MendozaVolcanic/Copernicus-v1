name: Re-descargar TODOS los Volcanes

on:
  workflow_dispatch:
    inputs:
      confirmar:
        description: 'Escribir YES para confirmar borrado'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  redescargar-todos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar confirmacion
        run: |
          if [ "${{ github.event.inputs.confirmar }}" != "YES" ]; then
            echo "‚ùå Debes escribir YES para confirmar"
            echo "‚ö†Ô∏è Este workflow borrar√° TODAS las im√°genes PNG"
            exit 1
          fi
          echo "‚úÖ Confirmaci√≥n recibida"
      
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Contar imagenes actuales
        run: |
          echo "üìä ESTADO ACTUAL:"
          total=$(find docs/sentinel2/ -name "*.png" -type f 2>/dev/null | wc -l || echo 0)
          echo "   Im√°genes PNG: $total"
      
      - name: Borrar TODAS las imagenes PNG
        run: |
          echo "üóëÔ∏è BORRANDO IM√ÅGENES..."
          find docs/sentinel2/ -name "*.png" -type f -delete
          
          # Tambi√©n borrar metadata.csv
          find docs/sentinel2/ -name "metadata.csv" -type f -delete
          
          echo "‚úÖ Im√°genes y metadata borrados"
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Re-descargar con MAX_CLOUD_COVER=100
        env:
          SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
          SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        run: |
          echo "üì• RE-DESCARGANDO TODOS LOS VOLCANES..."
          echo "Configuraci√≥n: MAX_CLOUD_COVER=100 (incluso d√≠as nublados)"
          python sentinel2_downloader.py
      
      - name: Contar imagenes nuevas
        run: |
          echo "üìä ESTADO FINAL:"
          total_nuevas=$(find docs/sentinel2/ -name "*.png" -type f 2>/dev/null | wc -l || echo 0)
          echo "   Im√°genes nuevas: $total_nuevas"
          
          if [ $total_nuevas -eq 0 ]; then
            echo "‚ùå No se descargaron im√°genes nuevas"
            exit 1
          fi
      
      - name: Commit cambios con retry
        run: |
          git config user.name "RedownloadBot"
          git config user.email "redownload@copernicus.com"
          
          git add docs/sentinel2/
          
          if git diff --quiet --staged; then
            echo "‚ö†Ô∏è No hay cambios para guardar"
            exit 0
          fi
          
          # Commit
          git commit -m "Re-descarga: TODOS los volcanes con MAX_CLOUD_COVER=100"
          
          # Push con retry (hasta 5 intentos)
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "üì§ Intento $((retry_count + 1)) de push..."
            
            # Pull con rebase
            if git pull origin main --rebase -X ours; then
              echo "‚úÖ Pull exitoso"
            else
              echo "‚ö†Ô∏è Pull fall√≥, continuando..."
            fi
            
            # Push
            if git push origin main; then
              echo "‚úÖ Push exitoso"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "‚ö†Ô∏è Push fall√≥, esperando $((retry_count * 3)) segundos..."
                sleep $((retry_count * 3))
              fi
            fi
          done
          
          echo "‚ùå Push fall√≥ despu√©s de $max_retries intentos"
          echo "‚ö†Ô∏è Las im√°genes est√°n descargadas pero no se guardaron en GitHub"
          exit 1
