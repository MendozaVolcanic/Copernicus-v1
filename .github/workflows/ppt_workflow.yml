name: Generar PPT Evaluacion Mensual

on:
  workflow_run:
    workflows: ["Generar Timelapse GIF"]
    types:
      - completed
  
  workflow_dispatch:

concurrency:
  group: ppt-generator
  cancel-in-progress: true

jobs:
  generate-ppt:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: true
      
      - name: Descargar archivos LFS
        run: git lfs pull

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install python-pptx

      - name: Verificar plantilla PPT
        run: |
          echo "Listando contenido de data/..."
          ls -la data/
          echo ""
          echo "Buscando archivos .pptx en data/..."
          find data/ -name "*.pptx" -type f
          echo ""
          
          if [ ! -f "data/Cambios_morfologicos.pptx" ]; then
            echo "ERROR: Plantilla NO encontrada"
            echo ""
            echo "Ruta esperada: data/Cambios_morfologicos.pptx"
            echo ""
            echo "Archivos encontrados en data/:"
            ls -la data/ || echo "Carpeta data/ no existe"
            echo ""
            exit 1
          fi
          
          echo "Plantilla encontrada:"
          ls -lh data/Cambios_morfologicos.pptx

      - name: Generar PPT
        run: |
          python ppt_generator.py

      - name: Guardar cambios en GitHub
        run: |
          git config --global user.name "PPTBot"
          git config --global user.email "ppt@sentinel2.com"
          
          git add docs/sentinel2/**/reportes/*.pptx
          
          if ! git diff --quiet --staged; then
            git commit -m "PPT Evaluacion Mensual generado - $(date +'%Y-%m')"
            git pull origin main --rebase -X ours
            git push origin main
          else
            echo "No hay nuevos PPTs para guardar"
          fi
