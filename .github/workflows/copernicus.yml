name: Monitoreo Copernicus Autom√°tico

on:
  schedule:
    # Ejecutar diariamente a las 06:00 UTC (03:00 Chile)
    - cron: '0 6 * * *'
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:

# PERMISOS NECESARIOS PARA PUSH
permissions:
  contents: write

jobs:
  monitoreo-completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas pytz Pillow python-pptx
      
      - name: üì• Descargar im√°genes Sentinel-2
        env:
          SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
          SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        run: |
          echo "üõ∞Ô∏è Descargando im√°genes √∫ltimos 60 d√≠as..."
          python sentinel2_downloader.py
      
      - name: üé¨ Generar timelapses autom√°ticos
        run: |
          echo "üé¨ Generando timelapses √∫ltimos 30 d√≠as para dashboard..."
          python timelapse_generator_auto.py
      
      - name: üìä Generar PPT mensuales (d√≠a 1 del mes)
        run: |
          echo "üìä Verificando si es d√≠a 1 del mes..."
          DIA=$(date +%d)
          
          if [ "$DIA" = "01" ]; then
            echo "‚úÖ Es d√≠a 1, generando PPT mensual..."
            python ppt_generator.py
          else
            echo "‚è≠Ô∏è No es d√≠a 1 (d√≠a actual: $DIA), omitiendo PPT"
          fi
      
      - name: üíæ Guardar cambios en GitHub
        run: |
          git config --global user.name "Copernicus Bot"
          git config --global user.email "bot@copernicus.local"
          
          git add -A
          
          if ! git diff --quiet --staged; then
            FECHA=$(date +'%Y-%m-%d %H:%M')
            git commit -m "ü§ñ Actualizaci√≥n autom√°tica: $FECHA"
            
            # Push con reintentos
            max_retries=5
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "üì§ Intento $((retry_count + 1)) de push..."
              
              if git pull origin main --rebase -X ours; then
                echo "‚úÖ Pull exitoso"
              else
                echo "‚ö†Ô∏è Pull fall√≥, continuando..."
              fi
              
              if git push origin main; then
                echo "‚úÖ Push exitoso"
                exit 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep $((retry_count * 2))
                fi
              fi
            done
            
            echo "‚ùå Push fall√≥ despu√©s de $max_retries intentos"
            exit 1
          else
            echo "‚ÑπÔ∏è No hay cambios para guardar"
          fi
