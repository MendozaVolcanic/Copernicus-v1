name: Monitoreo Copernicus Automatico

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  monitoreo-completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas pytz Pillow python-pptx
      
      - name: Descargar imagenes Sentinel-2
        env:
          SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
          SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        run: |
          echo "Descargando imagenes ultimos 60 dias..."
          python sentinel2_downloader.py
      
      - name: Generar timelapses automaticos
        run: |
          echo "Generando timelapses ultimos 30 dias para dashboard..."
          python timelapse_generator_auto.py
      
      - name: Generar PPT mensuales (dia 1 del mes)
        run: |
          echo "Verificando si es dia 1 del mes..."
          DIA=$(date +%d)
          
          if [ "$DIA" = "01" ]; then
            echo "Es dia 1, generando PPT mensual..."
            python ppt_generator.py
          else
            echo "No es dia 1 (dia actual: $DIA), omitiendo PPT"
          fi
      
      - name: Guardar cambios en GitHub
        run: |
          git config --global user.name "Copernicus Bot"
          git config --global user.email "bot@copernicus.local"
          
          git add -A
          
          if ! git diff --quiet --staged; then
            FECHA=$(date +'%Y-%m-%d %H:%M')
            git commit -m "Actualizacion automatica: $FECHA"
            
            max_retries=5
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Intento $((retry_count + 1)) de push..."
              
              if git pull origin main --rebase -X ours; then
                echo "Pull exitoso"
              else
                echo "Pull fallo, continuando..."
              fi
              
              if git push origin main; then
                echo "Push exitoso"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep $((retry_count * 2))
                fi
              fi
            done
            
            if [ $retry_count -eq $max_retries ]; then
              echo "Push fallo despues de $max_retries intentos"
              exit 1
            fi
          else
            echo "No hay cambios para guardar"
          fi
      
      - name: Configurar GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: Subir artefacto a Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'
      
      - name: Deploy a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
