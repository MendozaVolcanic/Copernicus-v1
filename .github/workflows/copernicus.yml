name: Monitoreo Copernicus Automtico

on:
  schedule:
    # Ejecutar diariamente a las 06:00 UTC (03:00 Chile)
    - cron: '0 6 * * *'
  
  # Permitir ejecucin manual
  workflow_dispatch:

# PERMISOS NECESARIOS PARA PUSH
permissions:
  contents: write

jobs:
  monitoreo-completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas pytz Pillow python-pptx
      
      - name:  Descargar imgenes Sentinel-2
        env:
          SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
          SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        run: |
          echo " Descargando imgenes ltimos 60 das..."
          python sentinel2_downloader.py
      
      - name:  Generar timelapses automticos
        run: |
          echo " Generando timelapses ltimos 30 das para dashboard..."
          python timelapse_generator_auto.py
      
      - name:  Generar PPT mensuales (da 1 del mes)
        run: |
          echo " Verificando si es da 1 del mes..."
          DIA=$(date +%d)
          
          if [ "$DIA" = "01" ]; then
            echo " Es da 1, generando PPT mensual..."
            python ppt_generator.py
          else
            echo " No es da 1 (da actual: $DIA), omitiendo PPT"
          fi
      
      - name:  Guardar cambios en GitHub
        run: |
          git config --global user.name "Copernicus Bot"
          git config --global user.email "bot@copernicus.local"
          
          git add -A
          
          if ! git diff --quiet --staged; then
            FECHA=$(date +'%Y-%m-%d %H:%M')
            git commit -m " Actualizacin automtica: $FECHA"
            
            # Push con reintentos
            max_retries=5
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo " Intento $((retry_count + 1)) de push..."
              
              if git pull origin main --rebase -X ours; then
                echo " Pull exitoso"
              else
                echo " Pull fall, continuando..."
              fi
              
              if git push origin main; then
                echo " Push exitoso"
                exit 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep $((retry_count * 2))
                fi
              fi
            done
            
            echo " Push fall despus de $max_retries intentos"
            exit 1
          else
            echo " No hay cambios para guardar"
          fi
