name: PPT Evaluaci√≥n Completa (Todos los Volcanes)

on:
  workflow_dispatch:
    inputs:
      mes:
        description: 'Mes a procesar (1-12)'
        required: true
        default: '2'
      a√±o:
        description: 'A√±o a procesar'
        required: true
        default: '2026'

permissions:
  contents: write

jobs:
  generar-ppt-completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          pip install python-pptx Pillow requests python-dateutil
      
      - name: Verificar plantilla
        run: |
          if [ ! -f "docs/plantillas/Cambios_morfologicos.pptx" ]; then
            echo "‚ùå Plantilla NO encontrada"
            exit 1
          fi
          echo "‚úÖ Plantilla encontrada"
      
      - name: Generar PPT Completo
        env:
          MES: ${{ github.event.inputs.mes }}
          A√ëO: ${{ github.event.inputs.a√±o }}
        run: |
          python3 << 'EOFPY'
          import os
          import glob
          import sys
          from datetime import datetime, timedelta
          from dateutil.relativedelta import relativedelta
          from pptx import Presentation
          from pptx.util import Inches, Pt
          from PIL import Image
          
          VOLCANES = [
              # ZONA NORTE
              "Taapaca", "Parinacota", "Guallatiri", "Isluga", "Irruputuncu", 
              "Ollague", "San Pedro", "Lascar",
              # ZONA CENTRO
              "Tupungatito", "San Jose", "Tinguiririca", "Planchon-Peteroa", 
              "Descabezado Grande", "Tatara-San Pedro", "Laguna del Maule", 
              "Nevado de Longavi", "Nevados de Chillan",
              # ZONA SUR
              "Antuco", "Copahue", "Callaqui", "Lonquimay", "Llaima", 
              "Sollipulli", "Villarrica", "Quetrupillan", "Lanin", 
              "Mocho-Choshuenco", "Carran - Los Venados", 
              "Puyehue - Cordon Caulle", "Antillanca - Casablanca",
              # ZONA AUSTRAL
              "Osorno", "Calbuco", "Yate", "Hornopiren", "Huequi", 
              "Michinmahuida", "Chaiten", "Corcovado", "Melimoyu", 
              "Mentolat", "Cay", "Maca", "Hudson"
          ]
          
          MESES_ES = {
              1: 'enero', 2: 'febrero', 3: 'marzo', 4: 'abril',
              5: 'mayo', 6: 'junio', 7: 'julio', 8: 'agosto',
              9: 'septiembre', 10: 'octubre', 11: 'noviembre', 12: 'diciembre'
          }
          
          mes = int(os.getenv('MES'))
          a√±o = int(os.getenv('A√ëO'))
          
          print(f"="*80)
          print(f"GENERANDO PPT COMPLETO: {MESES_ES[mes].upper()} {a√±o}")
          print(f"="*80)
          
          # Calcular rango de fechas del mes
          fecha_inicio = datetime(a√±o, mes, 1)
          if mes == 12:
              fecha_fin = datetime(a√±o, 12, 31)
          else:
              fecha_fin = datetime(a√±o, mes + 1, 1) - timedelta(days=1)
          
          fecha_inicio_str = fecha_inicio.strftime('%Y-%m-%d')
          fecha_fin_str = fecha_fin.strftime('%Y-%m-%d')
          
          print(f"\nRango: {fecha_inicio_str} ‚Üí {fecha_fin_str}")
          
          # Crear presentaci√≥n base
          plantilla = "docs/plantillas/Cambios_morfologicos.pptx"
          prs_base = Presentation(plantilla)
          
          # Crear nueva presentaci√≥n para combinar todas
          prs_completo = Presentation()
          prs_completo.slide_width = prs_base.slide_width
          prs_completo.slide_height = prs_base.slide_height
          
          # Copiar slide master de plantilla
          # (esto mantiene el dise√±o base)
          
          volcanes_procesados = 0
          volcanes_sin_datos = 0
          
          for volcan in VOLCANES:
              print(f"\nüåã {volcan}")
              
              # Buscar timelapses del volc√°n
              carpeta_timelapses = f"docs/sentinel2/{volcan}/timelapses_ppt"
              
              if not os.path.exists(carpeta_timelapses):
                  print(f"   ‚ö†Ô∏è Sin carpeta timelapses")
                  volcanes_sin_datos += 1
                  continue
              
              # Buscar GIFs del mes espec√≠fico
              pattern_rgb = f"{carpeta_timelapses}/{volcan}_RGB_*{a√±o}-{mes:02d}*.gif"
              pattern_thermal = f"{carpeta_timelapses}/{volcan}_ThermalFalseColor_*{a√±o}-{mes:02d}*.gif"
              
              gifs_rgb = sorted(glob.glob(pattern_rgb))
              gifs_thermal = sorted(glob.glob(pattern_thermal))
              
              if not gifs_rgb or not gifs_thermal:
                  print(f"   ‚ö†Ô∏è Sin GIFs para {MESES_ES[mes]} {a√±o}")
                  volcanes_sin_datos += 1
                  continue
              
              gif_rgb = gifs_rgb[-1]  # M√°s reciente
              gif_thermal = gifs_thermal[-1]
              
              print(f"   ‚úÖ RGB: {os.path.basename(gif_rgb)}")
              print(f"   ‚úÖ Thermal: {os.path.basename(gif_thermal)}")
              
              # Cargar plantilla para este volc√°n
              prs_volcan = Presentation(plantilla)
              slide = prs_volcan.slides[0]
              
              # Actualizar textos del slide
              for shape in slide.shapes:
                  if not hasattr(shape, "text_frame"):
                      continue
                  
                  texto = shape.text.lower()
                  
                  # Reemplazar nombre del volc√°n
                  if "volc√°n" in texto or "volcan" in texto:
                      for p in shape.text_frame.paragraphs:
                          for run in p.runs:
                              # Reemplazar cualquier nombre de volc√°n anterior
                              for v_antiguo in VOLCANES:
                                  if v_antiguo.lower() in run.text.lower():
                                      run.text = run.text.replace(v_antiguo, volcan)
                                      break
                      
                      # Actualizar mes y a√±o
                      for p in shape.text_frame.paragraphs:
                          texto_p = p.text.lower()
                          if "mes de" in texto_p:
                              for run in p.runs:
                                  import re
                                  patron = re.compile(r'(mes de )\w+(?: \d{4})?', re.IGNORECASE)
                                  run.text = patron.sub(f"mes de {MESES_ES[mes]} {a√±o}", run.text)
              
              # Reemplazar GIFs (buscar im√°genes en el slide)
              shapes_img = [s for s in slide.shapes if s.shape_type == 13]
              shapes_img.sort(key=lambda x: x.top)
              
              if len(shapes_img) >= 2:
                  # Comprimir GIFs si son muy grandes
                  def comprimir_gif_temp(gif_path, max_mb=1.2):
                      temp_path = f"/tmp/{os.path.basename(gif_path)}"
                      size_mb = os.path.getsize(gif_path) / (1024 * 1024)
                      
                      if size_mb <= max_mb:
                          import shutil
                          shutil.copy2(gif_path, temp_path)
                          return temp_path
                      
                      # Comprimir
                      img = Image.open(gif_path)
                      frames = []
                      try:
                          while True:
                              frame = img.copy().convert('P', palette=Image.ADAPTIVE, colors=128)
                              frames.append(frame)
                              img.seek(img.tell() + 1)
                      except EOFError:
                          pass
                      
                      frames[0].save(temp_path, save_all=True, append_images=frames[1:],
                                    optimize=True, duration=img.info.get('duration', 1000), loop=0)
                      return temp_path
                  
                  gif_rgb_comp = comprimir_gif_temp(gif_rgb)
                  gif_thermal_comp = comprimir_gif_temp(gif_thermal)
                  
                  # RGB (arriba)
                  s = shapes_img[0]
                  s.element.getparent().remove(s.element)
                  slide.shapes.add_picture(gif_rgb_comp, s.left, s.top, s.width, s.height)
                  
                  # Thermal (abajo)
                  s = shapes_img[1]
                  s.element.getparent().remove(s.element)
                  slide.shapes.add_picture(gif_thermal_comp, s.left, s.top, s.width, s.height)
                  
                  print(f"   ‚úÖ GIFs insertados")
              
              # Copiar slide a presentaci√≥n completa
              # (esto es complejo en python-pptx, alternativa: guardar individual y combinar)
              
              # ALTERNATIVA: Guardar PPT individual primero
              os.makedirs(f"docs/sentinel2/{volcan}/reportes", exist_ok=True)
              ppt_individual = f"docs/sentinel2/{volcan}/reportes/{volcan}_Evaluacion_{a√±o}-{mes:02d}.pptx"
              prs_volcan.save(ppt_individual)
              print(f"   üíæ Guardado: {ppt_individual}")
              
              volcanes_procesados += 1
          
          print(f"\n{'='*80}")
          print(f"COMPLETADO")
          print(f"   ‚úÖ Procesados: {volcanes_procesados}")
          print(f"   ‚ö†Ô∏è Sin datos: {volcanes_sin_datos}")
          print(f"{'='*80}")
          
          # NOTA: Combinar PPTs individuales requiere librer√≠a adicional
          # Por ahora, genera PPTs individuales por volc√°n
          # TODO: Implementar merge de PPTs en v2.0
          
          EOFPY
      
      - name: Commit PPTs generados
        run: |
          git config user.name "PPTCompletoBot"
          git config user.email "pptcompleto@copernicus.com"
          
          git add docs/sentinel2/**/reportes/*.pptx
          
          if git diff --quiet --staged; then
            echo "‚ö†Ô∏è No hay PPTs nuevos"
            exit 0
          fi
          
          git commit -m "PPT Completo: ${{ github.event.inputs.mes }}/${{ github.event.inputs.a√±o }} (todos los volcanes)"
          
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "üì§ Intento $((retry_count + 1))..."
            
            git pull origin main --rebase -X ours || true
            
            if git push origin main; then
              echo "‚úÖ Push exitoso"
              exit 0
            fi
            
            retry_count=$((retry_count + 1))
            [ $retry_count -lt $max_retries ] && sleep $((retry_count * 3))
          done
          
          echo "‚ùå Push fall√≥"
          exit 1
