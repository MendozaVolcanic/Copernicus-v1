# ============================================================================
# WORKFLOW: PPT EVALUACI√ìN COMPLETA - TODOS LOS VOLCANES
# ============================================================================
# CORRECCI√ìN: Reemplazar "a√±o" por "anio" para evitar error GitHub Actions
# GitHub Actions no soporta caracteres con tilde en nombres de inputs
# ============================================================================

name: PPT Evaluaci√≥n Completa (Todos los Volcanes)

on:
  workflow_dispatch:
    inputs:
      mes:
        description: 'Mes a procesar (1-12)'
        required: true
        default: '2'
      anio:  # CORREGIDO: "a√±o" ‚Üí "anio" (sin tilde)
        description: 'A√±o a procesar'
        required: true
        default: '2026'

permissions:
  contents: write

jobs:
  generar-ppt-completo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          pip install python-pptx Pillow requests python-dateutil
      
      - name: Verificar plantilla
        run: |
          if [ ! -f "docs/plantillas/Cambios_morfologicos.pptx" ]; then
            echo "‚ùå Plantilla NO encontrada"
            exit 1
          fi
          echo "‚úÖ Plantilla encontrada"
      
      - name: Generar PPT Completo
        env:
          MES: ${{ github.event.inputs.mes }}
          ANIO: ${{ github.event.inputs.anio }}  # CORREGIDO: "a√±o" ‚Üí "anio"
        run: |
          python3 << 'EOFPY'
          # ====================================================================
          # GENERADOR PPT COMPLETO - INLINE PYTHON SCRIPT
          # ====================================================================
          # Genera PPT individual para cada volc√°n del mes seleccionado
          # Usa variables de entorno MES y ANIO de GitHub Actions
          # ====================================================================
          
          import os
          import glob
          import sys
          from datetime import datetime, timedelta
          from dateutil.relativedelta import relativedelta
          from pptx import Presentation
          from pptx.util import Inches, Pt
          from PIL import Image
          
          # Lista completa de 43 volcanes activos
          VOLCANES = [
              # ZONA NORTE (8 volcanes)
              "Taapaca", "Parinacota", "Guallatiri", "Isluga", "Irruputuncu", 
              "Ollague", "San Pedro", "Lascar",
              # ZONA CENTRO (9 volcanes)
              "Tupungatito", "San Jose", "Tinguiririca", "Planchon-Peteroa", 
              "Descabezado Grande", "Tatara-San Pedro", "Laguna del Maule", 
              "Nevado de Longavi", "Nevados de Chillan",
              # ZONA SUR (13 volcanes)
              "Antuco", "Copahue", "Callaqui", "Lonquimay", "Llaima", 
              "Sollipulli", "Villarrica", "Quetrupillan", "Lanin", 
              "Mocho-Choshuenco", "Carran - Los Venados", 
              "Puyehue - Cordon Caulle", "Antillanca - Casablanca",
              # ZONA AUSTRAL (13 volcanes)
              "Osorno", "Calbuco", "Yate", "Hornopiren", "Huequi", 
              "Michinmahuida", "Chaiten", "Corcovado", "Melimoyu", 
              "Mentolat", "Cay", "Maca", "Hudson"
          ]
          
          # Diccionario de nombres de meses en espa√±ol
          MESES_ES = {
              1: 'enero', 2: 'febrero', 3: 'marzo', 4: 'abril',
              5: 'mayo', 6: 'junio', 7: 'julio', 8: 'agosto',
              9: 'septiembre', 10: 'octubre', 11: 'noviembre', 12: 'diciembre'
          }
          
          # Leer variables de entorno de GitHub Actions
          mes = int(os.getenv('MES'))
          anio = int(os.getenv('ANIO'))  # CORREGIDO: usar ANIO en lugar de A√ëO
          
          print(f"="*80)
          print(f"GENERANDO PPT COMPLETO: {MESES_ES[mes].upper()} {anio}")
          print(f"="*80)
          
          # Calcular rango de fechas del mes seleccionado
          fecha_inicio = datetime(anio, mes, 1)
          if mes == 12:
              fecha_fin = datetime(anio, 12, 31)
          else:
              fecha_fin = datetime(anio, mes + 1, 1) - timedelta(days=1)
          
          fecha_inicio_str = fecha_inicio.strftime('%Y-%m-%d')
          fecha_fin_str = fecha_fin.strftime('%Y-%m-%d')
          
          print(f"\nRango: {fecha_inicio_str} ‚Üí {fecha_fin_str}")
          
          # Ruta de plantilla base
          plantilla = "docs/plantillas/Cambios_morfologicos.pptx"
          prs_base = Presentation(plantilla)
          
          # Crear nueva presentaci√≥n (placeholder para futuro merge)
          prs_completo = Presentation()
          prs_completo.slide_width = prs_base.slide_width
          prs_completo.slide_height = prs_base.slide_height
          
          # Contadores de progreso
          volcanes_procesados = 0
          volcanes_sin_datos = 0
          
          # Iterar sobre cada volc√°n
          for volcan in VOLCANES:
              print(f"\nüåã {volcan}")
              
              # Buscar carpeta de timelapses del volc√°n
              carpeta_timelapses = f"docs/sentinel2/{volcan}/timelapses_ppt"
              
              if not os.path.exists(carpeta_timelapses):
                  print(f"   ‚ö†Ô∏è Sin carpeta timelapses")
                  volcanes_sin_datos += 1
                  continue
              
              # Buscar GIFs del mes espec√≠fico (patr√≥n: *YYYY-MM*.gif)
              pattern_rgb = f"{carpeta_timelapses}/{volcan}_RGB_*{anio}-{mes:02d}*.gif"
              pattern_thermal = f"{carpeta_timelapses}/{volcan}_ThermalFalseColor_*{anio}-{mes:02d}*.gif"
              
              gifs_rgb = sorted(glob.glob(pattern_rgb))
              gifs_thermal = sorted(glob.glob(pattern_thermal))
              
              if not gifs_rgb or not gifs_thermal:
                  print(f"   ‚ö†Ô∏è Sin GIFs para {MESES_ES[mes]} {anio}")
                  volcanes_sin_datos += 1
                  continue
              
              # Tomar el GIF m√°s reciente de cada tipo
              gif_rgb = gifs_rgb[-1]
              gif_thermal = gifs_thermal[-1]
              
              print(f"   ‚úÖ RGB: {os.path.basename(gif_rgb)}")
              print(f"   ‚úÖ Thermal: {os.path.basename(gif_thermal)}")
              
              # Cargar plantilla para este volc√°n
              prs_volcan = Presentation(plantilla)
              slide = prs_volcan.slides[0]
              
              # ============================================================
              # ACTUALIZAR TEXTOS DEL SLIDE
              # ============================================================
              # Buscar y reemplazar nombre del volc√°n y mes/a√±o en textos
              # ============================================================
              for shape in slide.shapes:
                  if not hasattr(shape, "text_frame"):
                      continue
                  
                  texto = shape.text.lower()
                  
                  # Reemplazar nombre del volc√°n en cualquier texto que mencione volcanes
                  if "volc√°n" in texto or "volcan" in texto:
                      for p in shape.text_frame.paragraphs:
                          for run in p.runs:
                              # Buscar y reemplazar cualquier nombre de volc√°n anterior
                              for v_antiguo in VOLCANES:
                                  if v_antiguo.lower() in run.text.lower():
                                      run.text = run.text.replace(v_antiguo, volcan)
                                      break
                      
                      # Actualizar mes y a√±o en textos que mencionen "mes de"
                      for p in shape.text_frame.paragraphs:
                          texto_p = p.text.lower()
                          if "mes de" in texto_p:
                              for run in p.runs:
                                  import re
                                  # Patr√≥n: "mes de [cualquier_mes] [a√±o]"
                                  patron = re.compile(r'(mes de )\w+(?: \d{4})?', re.IGNORECASE)
                                  run.text = patron.sub(f"mes de {MESES_ES[mes]} {anio}", run.text)
              
              # ============================================================
              # REEMPLAZAR GIFs EN SLIDE
              # ============================================================
              # Buscar placeholders de imagen y reemplazarlos con GIFs
              # ============================================================
              shapes_img = [s for s in slide.shapes if s.shape_type == 13]
              shapes_img.sort(key=lambda x: x.top)  # Ordenar de arriba a abajo
              
              if len(shapes_img) >= 2:
                  # Funci√≥n para comprimir GIF si es muy grande (>1.2 MB)
                  def comprimir_gif_temp(gif_path, max_mb=1.2):
                      temp_path = f"/tmp/{os.path.basename(gif_path)}"
                      size_mb = os.path.getsize(gif_path) / (1024 * 1024)
                      
                      # Si es peque√±o, copiar directo
                      if size_mb <= max_mb:
                          import shutil
                          shutil.copy2(gif_path, temp_path)
                          return temp_path
                      
                      # Comprimir reduciendo colores a 128
                      img = Image.open(gif_path)
                      frames = []
                      try:
                          while True:
                              frame = img.copy().convert('P', palette=Image.ADAPTIVE, colors=128)
                              frames.append(frame)
                              img.seek(img.tell() + 1)
                      except EOFError:
                          pass
                      
                      # Guardar con optimizaci√≥n
                      frames[0].save(temp_path, save_all=True, append_images=frames[1:],
                                    optimize=True, duration=img.info.get('duration', 1000), loop=0)
                      return temp_path
                  
                  # Comprimir ambos GIFs
                  gif_rgb_comp = comprimir_gif_temp(gif_rgb)
                  gif_thermal_comp = comprimir_gif_temp(gif_thermal)
                  
                  # Reemplazar imagen RGB (arriba)
                  s = shapes_img[0]
                  s.element.getparent().remove(s.element)
                  slide.shapes.add_picture(gif_rgb_comp, s.left, s.top, s.width, s.height)
                  
                  # Reemplazar imagen Thermal (abajo)
                  s = shapes_img[1]
                  s.element.getparent().remove(s.element)
                  slide.shapes.add_picture(gif_thermal_comp, s.left, s.top, s.width, s.height)
                  
                  print(f"   ‚úÖ GIFs insertados")
              
              # ============================================================
              # GUARDAR PPT INDIVIDUAL
              # ============================================================
              # Guardar en: docs/sentinel2/{volcan}/reportes/
              # ============================================================
              os.makedirs(f"docs/sentinel2/{volcan}/reportes", exist_ok=True)
              ppt_individual = f"docs/sentinel2/{volcan}/reportes/{volcan}_Evaluacion_{anio}-{mes:02d}.pptx"
              prs_volcan.save(ppt_individual)
              print(f"   üíæ Guardado: {ppt_individual}")
              
              volcanes_procesados += 1
          
          # Resumen final
          print(f"\n{'='*80}")
          print(f"COMPLETADO")
          print(f"   ‚úÖ Procesados: {volcanes_procesados}")
          print(f"   ‚ö†Ô∏è Sin datos: {volcanes_sin_datos}")
          print(f"{'='*80}")
          
          # NOTA: Merge de PPTs requiere librer√≠a adicional
          # Por ahora genera PPTs individuales (1 por volc√°n)
          # TODO v2.0: Implementar combinaci√≥n en archivo √∫nico
          
          EOFPY
      
      - name: Commit PPTs generados
        run: |
          git config user.name "PPTCompletoBot"
          git config user.email "pptcompleto@copernicus.com"
          
          # Agregar todos los PPTs generados
          git add docs/sentinel2/**/reportes/*.pptx
          
          # Verificar si hay cambios
          if git diff --quiet --staged; then
            echo "‚ö†Ô∏è No hay PPTs nuevos"
            exit 0
          fi
          
          # Commit con informaci√≥n del mes/a√±o
          git commit -m "PPT Completo: ${{ github.event.inputs.mes }}/${{ github.event.inputs.anio }} (todos los volcanes)"
          
          # Push con retry logic (5 intentos m√°ximo)
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "üì§ Intento $((retry_count + 1))..."
            
            # Pull con rebase para evitar conflictos
            git pull origin main --rebase -X ours || true
            
            # Intentar push
            if git push origin main; then
              echo "‚úÖ Push exitoso"
              exit 0
            fi
            
            # Si falla, esperar antes de reintentar
            retry_count=$((retry_count + 1))
            [ $retry_count -lt $max_retries ] && sleep $((retry_count * 3))
          done
          
          echo "‚ùå Push fall√≥ despu√©s de $max_retries intentos"
          exit 1
