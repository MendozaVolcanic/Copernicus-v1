name: Generar PPT Evaluacion

on:
  workflow_dispatch:
    inputs:
      volcan:
        description: 'Volcan a procesar'
        required: true
        type: choice
        options:
          - Villarrica
          - Llaima
          - Nevados de Chillan
          - Copahue
          - Puyehue-Cordon Caulle
          - Chaiten
          - Lascar
          - Lastarria
          - Isluga
          - Planchon-Peteroa
      
      fecha_inicio:
        description: 'Fecha inicio (YYYY-MM-DD)'
        required: true
        default: '2026-01-01'
      
      fecha_fin:
        description: 'Fecha fin (YYYY-MM-DD)'
        required: true
        default: '2026-02-05'

concurrency:
  group: ppt-generator-${{ github.event.inputs.volcan }}
  cancel-in-progress: false

jobs:
  generate-ppt:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: true
      
      - name: Descargar archivos LFS
        run: git lfs pull

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install python-pptx Pillow requests

      - name: Verificar plantilla PPT
        run: |
          if [ ! -f "data/Cambios_morfologicos.pptx" ]; then
            echo "ERROR: Plantilla NO encontrada en data/Cambios_morfologicos.pptx"
            exit 1
          fi
          echo "Plantilla encontrada"
          ls -lh data/Cambios_morfologicos.pptx

      - name: Generar timelapse para el rango seleccionado
        env:
          VOLCAN: ${{ github.event.inputs.volcan }}
          FECHA_INICIO: ${{ github.event.inputs.fecha_inicio }}
          FECHA_FIN: ${{ github.event.inputs.fecha_fin }}
        run: |
          python timelapse_generator.py

      - name: Generar PPT
        env:
          VOLCAN: ${{ github.event.inputs.volcan }}
          FECHA_INICIO: ${{ github.event.inputs.fecha_inicio }}
          FECHA_FIN: ${{ github.event.inputs.fecha_fin }}
        run: |
          python ppt_generator.py

      - name: Guardar cambios en GitHub
        run: |
          git config --global user.name "PPTBot"
          git config --global user.email "ppt@sentinel2.com"
          
          # Agregar PPTs y GIFs generados
          git add docs/sentinel2/**/reportes/*.pptx 2>/dev/null || true
          git add docs/sentinel2/**/timelapses/*.gif 2>/dev/null || true
          
          if ! git diff --quiet --staged 2>/dev/null; then
            git commit -m "PPT Evaluacion generado - ${{ github.event.inputs.volcan }} (${{ github.event.inputs.fecha_inicio }} a ${{ github.event.inputs.fecha_fin }})"
            git pull origin main --rebase -X ours
            git push origin main
            echo "PPT y timelapses guardados exitosamente"
          else
            echo "No hay archivos nuevos para guardar"
          fi
