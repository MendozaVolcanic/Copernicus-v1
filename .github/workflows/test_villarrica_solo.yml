name: Test Villarrica SOLO

on:
  workflow_dispatch:
    inputs:
      borrar_antes:
        description: '¬øBorrar im√°genes existentes antes? (SI/NO)'
        required: true
        default: 'NO'

permissions:
  contents: write

jobs:
  test-villarrica:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
      
      - name: Borrar im√°genes existentes (opcional)
        if: github.event.inputs.borrar_antes == 'SI'
        run: |
          echo "üóëÔ∏è Borrando im√°genes existentes de Villarrica..."
          find docs/sentinel2/Villarrica/ -name "*.png" -type f -delete
          echo "‚úÖ Im√°genes borradas"
      
      - name: Descargar SOLO Villarrica
        env:
          SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
          SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        run: |
          python3 << 'EOFPY'
          import sys
          sys.path.insert(0, '.')
          
          from sentinel2_downloader import *
          
          print("="*80)
          print("üåã TEST: DESCARGA SOLO VILLARRICA")
          print("="*80)
          
          # Autenticaci√≥n
          auth = SentinelHubAuth()
          searcher = SentinelHubSearcher(auth)
          downloader = SentinelHubDownloader(auth)
          
          # SOLO Villarrica
          volcan_config = {
              "lat": -39.42,
              "lon": -71.93,
              "id": "357120",
              "zona": "Sur",
              "activo": True
          }
          
          print("\nüîç Configuraci√≥n:")
          print(f"   MAX_CLOUD_COVER: 100 (descarga TODAS)")
          print(f"   BUFFER_KM: 3")
          print(f"   √öltimos: 60 d√≠as")
          
          # Procesar
          resultados = procesar_volcan("Villarrica", volcan_config, auth, searcher, downloader)
          
          if resultados:
              actualizar_metadata("Villarrica", resultados)
              print(f"\n‚úÖ Villarrica procesado: {len(resultados)} im√°genes")
          else:
              print("\n‚ö†Ô∏è No se descargaron im√°genes nuevas")
          
          print("="*80)
          EOFPY
      
      - name: Generar JSON fechas
        run: |
          python3 << 'EOFPY'
          import json
          import os
          import glob
          
          fechas = []
          for img_path in glob.glob('docs/sentinel2/Villarrica/*_RGB.png'):
              nombre = os.path.basename(img_path)
              fecha = nombre.split('_')[0]
              fechas.append(fecha)
          
          fechas_json = {
              "Villarrica": sorted(set(fechas))
          }
          
          os.makedirs('docs', exist_ok=True)
          with open('docs/fechas_disponibles_copernicus.json', 'w') as f:
              json.dump(fechas_json, f, indent=2)
          
          print(f"‚úÖ JSON generado: {len(fechas_json['Villarrica'])} fechas")
          EOFPY
      
      - name: Resumen de descarga
        run: |
          echo "üìä RESUMEN:"
          echo "   Im√°genes RGB:"
          find docs/sentinel2/Villarrica/ -name "*_RGB.png" | wc -l
          echo "   Im√°genes Thermal:"
          find docs/sentinel2/Villarrica/ -name "*_ThermalFalseColor.png" | wc -l
          echo ""
          echo "üìÖ Fechas m√°s recientes:"
          find docs/sentinel2/Villarrica/ -name "*_RGB.png" -type f | sort | tail -5 | xargs -n1 basename
      
      - name: Commit cambios
        run: |
          git config user.name "VillarricaBot"
          git config user.email "test@copernicus.com"
          
          git add docs/sentinel2/Villarrica/
          git add docs/fechas_disponibles_copernicus.json
          
          if ! git diff --quiet --staged; then
            git commit -m "Test: Villarrica con MAX_CLOUD_COVER=100"
            
            # Retry logic
            max_retries=3
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "üì§ Intento $((retry_count + 1)) de push..."
              
              if git pull origin main --rebase -X ours; then
                echo "‚úÖ Pull exitoso"
              fi
              
              if git push origin main; then
                echo "‚úÖ Push exitoso"
                exit 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  sleep $((retry_count * 2))
                fi
              fi
            done
            
            echo "‚ùå Push fall√≥ despu√©s de $max_retries intentos"
            exit 1
          else
            echo "‚ÑπÔ∏è No hay cambios para guardar"
          fi
