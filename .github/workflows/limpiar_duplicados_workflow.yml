name: Limpiar Carpetas Duplicadas y Renombrar

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  limpiar:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Limpiar carpetas con tildes (corruption UTF-8)
        run: |
          cd docs/sentinel2
          
          # Solo eliminar carpetas con nombres CORRUPTOS (tildes mal codificadas)
          # Las carpetas con nombres correctos se mantienen
          
          rm -rf "ChaitÃ©n" "LÃ¡scar" "San JosÃ©" "PlanchÃ³n-Peteroa" 2>/dev/null || true
          rm -rf "Nevado de LongavÃ­" "Nevados de ChillÃ¡n" "QuetrupillÃ¡n" 2>/dev/null || true
          rm -rf "LanÃ­n" "CarrÃ¡n - Los Venados" "Puyehue - CordÃ³n Caulle" 2>/dev/null || true
          rm -rf "HornopirÃ©n" "MacÃ¡" "Antillanca â€" Casablanca" 2>/dev/null || true
          
          echo "Carpetas con UTF-8 corrupto eliminadas"
      
      - name: Renombrar timelapses/ a timelapses_ppt/
        run: |
          cd docs/sentinel2
          
          # Renombrar SOLO si existe timelapses/ (no timelapses_ppt/)
          for volcan_dir in */; do
            if [ -d "${volcan_dir}timelapses" ] && [ ! -d "${volcan_dir}timelapses_ppt" ]; then
              mv "${volcan_dir}timelapses" "${volcan_dir}timelapses_ppt"
              echo "Renombrado: ${volcan_dir}timelapses -> timelapses_ppt"
            fi
          done
          
          echo "Carpetas renombradas"
      
      - name: Crear carpeta docs/timelapses/ para dashboard
        run: |
          mkdir -p docs/timelapses
          echo "Carpeta docs/timelapses/ creada (GIFs dashboard)"
          
      - name: Verificar estructura final
        run: |
          echo "=== Volcanes en docs/sentinel2/ ==="
          ls -d docs/sentinel2/*/ | sed 's|docs/sentinel2/||' | sed 's|/$||'
          
          echo ""
          echo "=== Subcarpetas timelapses_ppt/ ==="
          find docs/sentinel2/ -type d -name "timelapses_ppt" | wc -l
          
      - name: Commit cambios
        run: |
          git config user.name "CleanupBot"
          git config user.email "cleanup@copernicus.com"
          
          git add docs/sentinel2/ docs/timelapses/
          
          if ! git diff --quiet --staged; then
            git commit -m "Limpieza: UTF-8 + Renombrar timelapses/ a timelapses_ppt/"
            git push origin main
            echo "Cambios guardados"
          else
            echo "No hay cambios"
          fi
