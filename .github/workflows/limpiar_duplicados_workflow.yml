name: Limpiar Carpetas Duplicadas y Renombrar

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  limpiar:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Limpiar carpetas con tildes corruptas
        run: |
          cd docs/sentinel2
          
          echo "Eliminando carpetas con UTF-8 corrupto..."
          
          # Solo eliminar carpetas con nombres CORRUPTOS
          rm -rf "Chaiten" "Lascar" "San Jose" "Planchon-Peteroa" 2>/dev/null || true
          rm -rf "Nevado de Longavi" "Nevados de Chillan" "Quetrupillan" 2>/dev/null || true
          rm -rf "Lanin" "Carran - Los Venados" "Puyehue - Cordon Caulle" 2>/dev/null || true
          rm -rf "Hornopiren" "Maca" "Antillanca - Casablanca" 2>/dev/null || true
          
          echo "Carpetas corruptas eliminadas"
      
      - name: Renombrar timelapses a timelapses_ppt
        run: |
          cd docs/sentinel2
          
          echo "Renombrando carpetas timelapses/ a timelapses_ppt/..."
          
          # Renombrar SOLO si existe timelapses/ (no timelapses_ppt/)
          for volcan_dir in */; do
            if [ -d "${volcan_dir}timelapses" ] && [ ! -d "${volcan_dir}timelapses_ppt" ]; then
              mv "${volcan_dir}timelapses" "${volcan_dir}timelapses_ppt"
              echo "Renombrado: ${volcan_dir}timelapses -> timelapses_ppt"
            fi
          done
          
          echo "Carpetas renombradas"
      
      - name: Crear carpeta docs/timelapses para dashboard
        run: |
          mkdir -p docs/timelapses
          echo "Carpeta docs/timelapses/ creada (GIFs dashboard)"
          
      - name: Verificar estructura final
        run: |
          echo "=== Volcanes en docs/sentinel2/ ==="
          ls -d docs/sentinel2/*/ 2>/dev/null | sed 's|docs/sentinel2/||' | sed 's|/$||' || echo "Sin volcanes"
          
          echo ""
          echo "=== Subcarpetas timelapses_ppt/ ==="
          find docs/sentinel2/ -type d -name "timelapses_ppt" 2>/dev/null | wc -l
          
      - name: Commit cambios
        run: |
          git config user.name "CleanupBot"
          git config user.email "cleanup@copernicus.com"
          
          git add docs/sentinel2/ docs/timelapses/
          
          if ! git diff --quiet --staged; then
            git commit -m "Limpieza: UTF-8 + Renombrar timelapses a timelapses_ppt"
            git push origin main
            echo "Cambios guardados"
          else
            echo "No hay cambios"
          fi
